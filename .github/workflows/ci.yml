name: CI
on:
  pull_request:
  schedule:
    - cron: "0 6 * * *"

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      VITE_SUPABASE_URL: http://127.0.0.1:54321
      VITE_SUPABASE_ANON_KEY: test-anon
      VITE_WORKER_BASE_URL: http://127.0.0.1:54321
      VITE_COMMERCIAL_AGREEMENT_LEAD_ENDPOINT: http://127.0.0.1:54321/lead
      VITE_ESTIMATOR_LEAD_ENDPOINT: http://127.0.0.1:54321/lead
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci
      - run: npm run test:unit
      - run: npm run test:integration
      - run: npm run test:a11y
      - run: npm run link-audit

  e2e:
    runs-on: ubuntu-latest
    needs: test
    env:
      VITE_SUPABASE_URL: http://127.0.0.1:54321
      VITE_SUPABASE_ANON_KEY: test-anon
      VITE_WORKER_BASE_URL: http://127.0.0.1:54321
      VITE_COMMERCIAL_AGREEMENT_LEAD_ENDPOINT: http://127.0.0.1:54321/lead
      VITE_ESTIMATOR_LEAD_ENDPOINT: http://127.0.0.1:54321/lead
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npm run test:e2e
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report

  nightly:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    env:
      VITE_SUPABASE_URL: http://127.0.0.1:54321
      VITE_SUPABASE_ANON_KEY: test-anon
      VITE_WORKER_BASE_URL: http://127.0.0.1:54321
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci
      - run: npm run test:audit
      - run: npm run test:perf
      - run: npm run dev -- --host 127.0.0.1 --port 3000 & sleep 5
      - run: docker run --rm -v ${{ github.workspace }}:/zap/wrk owasp/zap2docker-stable zap-baseline.py -t http://127.0.0.1:3000 -c zap-baseline.conf
      - run: docker run --rm -v ${{ github.workspace }}:/scripts grafana/k6 run /scripts/k6/login-burst.js
